# ãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³æŠ•è³‡æˆ¦ç•¥ - æ¯Žæ—¥è‡ªå‹•åˆ†æžãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# æ¯Žæœ9æ™‚ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰ã«è‡ªå‹•å®Ÿè¡Œã—ã€çµæžœã‚’XSERVERã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™
# å®Ÿè¡Œå‰ã«X APIã§æœ€æ–°ã®#ãƒ“ãƒƒãƒˆã‚³ã‚¤ãƒ³æŠ•ç¨¿ã‚’å–å¾—ã—ã¦Pineconeã«ä¿å­˜

name: Daily BTC Analysis

on:
  # æ¯Žæ—¥0:00 UTCï¼ˆæ—¥æœ¬æ™‚é“9:00ï¼‰ã«å®Ÿè¡Œ
  schedule:
    - cron: '0 0 * * *'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  TZ: 'Asia/Tokyo'

jobs:
  # ãƒ¡ã‚¤ãƒ³åˆ†æžã‚’å®Ÿè¡Œ
  analyze:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create .env file
        run: |
          cat > .env << EOF
          # OpenAI API
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL=gpt-4o
          
          # Pinecone
          PINECONE_API_KEY=${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX_NAME=bitcoin
          
          # Twitter/X APIï¼ˆPineconeåŒæœŸç”¨ï¼‰
          TWITTER_BEARER_TOKEN=${{ secrets.TWITTER_BEARER_TOKEN }}
          TWITTER_TARGET_USERNAME=DriftSeiya
          
          # News & Market Data APIs
          ALPHA_VANTAGE_API_KEY=${{ secrets.ALPHA_VANTAGE_API_KEY }}
          POLYGON_API_KEY=${{ secrets.POLYGON_API_KEY }}
          FINNHUB_API_KEY=${{ secrets.FINNHUB_API_KEY }}
          FRED_API_KEY=${{ secrets.FRED_API_KEY }}
          
          # XSERVER FTP
          XSERVER_FTP_HOST=${{ secrets.XSERVER_FTP_HOST }}
          XSERVER_FTP_PORT=21
          XSERVER_FTP_USER=${{ secrets.XSERVER_FTP_USER }}
          XSERVER_FTP_PASSWORD=${{ secrets.XSERVER_FTP_PASSWORD }}
          XSERVER_REMOTE_DIR=${{ secrets.XSERVER_REMOTE_DIR }}
          XSERVER_PUBLIC_URL=${{ secrets.XSERVER_PUBLIC_URL }}
          
          # å®Ÿè¡Œè¨­å®š
          TIMEZONE=Asia/Tokyo
          LOG_LEVEL=INFO
          EOF

      - name: Create directories
        run: mkdir -p logs data

      - name: Download sync state
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: tweet-sync-state
          path: data/

      - name: Sync latest X posts to Pinecone
        run: |
          echo "ðŸ“¥ æœ€æ–°ã®XæŠ•ç¨¿ã‚’å–å¾—ã—ã¦Pineconeã«åŒæœŸ..."
          # X API Free Tier: æœˆ100ä»¶åˆ¶é™ã®ãŸã‚2ä»¶ã«åˆ¶é™ï¼ˆæœˆ30æ—¥Ã—2ä»¶=60ä»¶/æœˆï¼‰
          python scripts/sync_tweets_to_pinecone.py --max-tweets 2
          
          if [ -f data/tweet_sync_state.json ]; then
            echo ""
            echo "åŒæœŸçŠ¶æ…‹:"
            cat data/tweet_sync_state.json
          fi

      - name: Upload sync state
        uses: actions/upload-artifact@v4
        with:
          name: tweet-sync-state
          path: data/tweet_sync_state.json
          retention-days: 90
          overwrite: true

      - name: Run BTC Analysis
        run: python scripts/run_analysis.py
        timeout-minutes: 15

      - name: Upload analysis results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: analysis-results-${{ github.run_number }}
          path: |
            data/latest_prediction.json
            logs/
          retention-days: 30

      - name: Summary
        if: success()
        run: |
          echo "## âœ… BTCåˆ†æžãŒå®Œäº†ã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- å®Ÿè¡Œæ™‚åˆ»: $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')" >> $GITHUB_STEP_SUMMARY
          echo "- çµæžœãƒšãƒ¼ã‚¸: ${{ secrets.XSERVER_PUBLIC_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # XæŠ•ç¨¿åŒæœŸã‚µãƒžãƒªãƒ¼
          if [ -f data/tweet_sync_state.json ]; then
            SYNCED=$(python -c "import json; d=json.load(open('data/tweet_sync_state.json')); print(d.get('total_synced_count', 0))")
            MONTHLY=$(python -c "import json; d=json.load(open('data/tweet_sync_state.json')); print(d.get('monthly_api_calls', 0))")
            echo "### ðŸ“¥ XæŠ•ç¨¿åŒæœŸ" >> $GITHUB_STEP_SUMMARY
            echo "- Pineconeå†…æŠ•ç¨¿æ•°: **$SYNCED** ä»¶" >> $GITHUB_STEP_SUMMARY
            echo "- æœˆé–“APIä½¿ç”¨: **$MONTHLY** / 100" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f data/latest_prediction.json ]; then
            echo "### äºˆæ¸¬ã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            head -50 data/latest_prediction.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Failure notification
        if: failure()
        run: |
          echo "## âŒ BTCåˆ†æžãŒå¤±æ•—ã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
